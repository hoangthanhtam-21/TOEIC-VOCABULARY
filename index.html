<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOEIC Vocab Master</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080c14;--surface:#0e1420;--surface2:#141c2c;--surface3:#1a2438;
  --border:#1e2d47;--border2:#2a3f5f;
  --blue:#3b82f6;--blue2:#60a5fa;--teal:#14b8a6;--amber:#f59e0b;--green:#22c55e;--red:#ef4444;--purple:#8b5cf6;
  --text:#e8f0ff;--text2:#7a90b5;--text3:#4a6080;
  --radius:14px;
  --glow-blue: 0 0 30px rgba(59,130,246,.2);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* Grid overlay */
body::before{
  content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(59,130,246,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,.04) 1px,transparent 1px);
  background-size:60px 60px;pointer-events:none;z-index:0;
}
/* Glow orbs */
body::after{
  content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse 60% 40% at 80% 20%, rgba(59,130,246,.08) 0%, transparent 60%),
              radial-gradient(ellipse 50% 30% at 20% 80%, rgba(20,184,166,.06) 0%, transparent 60%);
  pointer-events:none;z-index:0;
}

#app{position:relative;z-index:1;max-width:920px;margin:0 auto;padding:24px 20px 80px;}

/* UTILITIES */
input,textarea,select{background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;padding:10px 14px;width:100%;outline:none;transition:border .2s;}
input:focus,textarea:focus,select:focus{border-color:var(--blue);}
label{font-size:11px;color:var(--text2);display:block;margin-bottom:6px;letter-spacing:.5px;text-transform:uppercase;}
.btn{padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;transition:all .15s;display:inline-flex;align-items:center;gap:6px;}
.btn-p{background:var(--blue);color:#fff;box-shadow:0 0 0 0 rgba(59,130,246,0);}.btn-p:hover{transform:translateY(-1px);box-shadow:var(--glow-blue);}
.btn-s{background:transparent;color:var(--text2);border:1px solid var(--border);}.btn-s:hover{border-color:var(--border2);color:var(--text);}
.btn-d{background:#1a0808;color:var(--red);border:1px solid rgba(239,68,68,.4);}.btn-d:hover{background:#2a1010;}
.btn-sm{padding:6px 13px;font-size:12px;border-radius:8px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;}
.screen{display:none;animation:fadeIn .25s ease;}.screen.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--surface2);border:1px solid var(--border2);border-radius:12px;padding:11px 22px;font-size:14px;opacity:0;pointer-events:none;transition:all .3s;z-index:9999;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
.badge{display:inline-block;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;}

/* LOADING */
#overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;gap:16px;}
#overlay.hidden{display:none;}
.ov-logo{font-family:'Sora',sans-serif;font-size:36px;font-weight:800;color:var(--blue);letter-spacing:-2px;}
.ov-logo span{color:var(--teal);}
.ov-msg{font-size:13px;color:var(--text2);}

/* SETUP */
.setup-wrap{max-width:480px;margin:50px auto;}
.setup-wrap h2{font-size:22px;font-weight:700;margin-bottom:10px;}
.setup-wrap p{color:var(--text2);font-size:14px;line-height:1.7;margin-bottom:22px;}
.setup-field{margin-bottom:14px;}
.api-note{font-size:12px;color:var(--text2);margin-top:18px;line-height:1.8;padding:14px;background:var(--surface2);border-radius:10px;}
.api-note a{color:var(--teal);text-decoration:none;}.api-note a:hover{text-decoration:underline;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding-bottom:22px;border-bottom:1px solid var(--border);margin-bottom:28px;flex-wrap:wrap;gap:10px;}
.logo-area{display:flex;align-items:baseline;gap:6px;}
.logo-text{font-size:24px;font-weight:800;letter-spacing:-1.5px;color:var(--blue);}
.logo-badge{font-size:11px;font-weight:700;background:var(--teal);color:#fff;padding:2px 8px;border-radius:6px;letter-spacing:1px;font-family:'JetBrains Mono',monospace;}
.hstats{display:flex;gap:22px;}
.hstat{text-align:center;}
.hstat-num{font-size:22px;font-weight:800;font-family:'Sora',sans-serif;color:var(--blue);}
.hstat-lbl{font-size:9px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-top:1px;}
.admin-gear{font-size:18px;cursor:pointer;opacity:.3;transition:opacity .2s;border:none;background:none;color:var(--text);padding:4px;}
.admin-gear:hover{opacity:.7;}
.admin-gear:disabled{opacity:.4;cursor:not-allowed;animation:rotate 1s linear infinite;}
@keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

/* NAV */
.nav-tabs{display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:5px;margin-bottom:26px;}
.tab-btn{flex:1;padding:10px 6px;border:none;border-radius:9px;cursor:pointer;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;background:transparent;color:var(--text2);transition:all .2s;white-space:nowrap;}
.tab-btn.active{background:var(--blue);color:#fff;}
.tab-btn:hover:not(.active){color:var(--text);background:var(--surface2);}

/* TOPIC GRID */
.topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(205px,1fr));gap:12px;margin-bottom:20px;}
.topic-card{background:var(--surface);border-radius:var(--radius);padding:18px;border:1px solid var(--border);cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.topic-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--tc-color,var(--blue));opacity:.6;transition:opacity .2s;}
.topic-card:hover{transform:translateY(-2px);border-color:var(--border2);box-shadow:0 8px 24px rgba(0,0,0,.4);}
.topic-card:hover::before{opacity:1;}
.t-emoji{font-size:26px;margin-bottom:8px;}
.t-name{font-size:15px;font-weight:700;margin-bottom:3px;}
.t-meta{font-size:11px;color:var(--text2);}
.t-bar{height:2px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden;}
.t-bar-fill{height:100%;border-radius:2px;transition:width .4s;}
.t-pct{font-size:11px;color:var(--green);margin-top:5px;font-family:'JetBrains Mono',monospace;}
.detail-hdr{display:flex;align-items:center;gap:10px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.back-btn{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:7px 13px;cursor:pointer;font-size:12px;color:var(--text2);font-family:'Sora',sans-serif;transition:all .15s;font-weight:600;}
.back-btn:hover{color:var(--text);border-color:var(--border2);}
.detail-title{font-size:18px;font-weight:700;}
.detail-badge{background:var(--blue);color:#fff;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-left:auto;font-family:'JetBrains Mono',monospace;}
.chip-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:8px;margin-bottom:22px;}
.chip{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 13px;cursor:pointer;transition:all .15s;}
.chip:hover{border-color:var(--blue);}
.chip.done{border-color:var(--green);opacity:.6;}
.chip-word{font-weight:700;font-size:13px;display:flex;align-items:center;gap:6px;font-family:'JetBrains Mono',monospace;}
.chip-vn{font-size:11px;color:var(--text2);margin-top:3px;}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.s-new{background:#7eb8f7;}.s-learning{background:var(--purple);}.s-review{background:var(--amber);}.s-mastered{background:var(--green);}
.topic-actions{display:flex;gap:10px;flex-wrap:wrap;}

/* STUDY */
.study-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.prg-wrap{flex:1;height:4px;background:var(--surface2);border-radius:3px;margin:0 14px;overflow:hidden;}
.prg-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--teal));border-radius:3px;transition:width .4s;}
.study-cnt{font-size:12px;color:var(--text2);white-space:nowrap;font-family:'JetBrains Mono',monospace;}
.card-wrap{perspective:1000px;margin:0 auto 22px;max-width:540px;}
.flashcard{position:relative;width:100%;padding-top:56%;transform-style:preserve-3d;transition:transform .5s cubic-bezier(.4,0,.2,1);cursor:pointer;}
.flashcard.flipped{transform:rotateY(180deg);}
.card-face{position:absolute;inset:0;border-radius:18px;padding:28px;display:flex;flex-direction:column;justify-content:center;align-items:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;border:1px solid var(--border);}
.cf{background:linear-gradient(135deg,#0f1825,#0a1020);}
.cb{background:linear-gradient(135deg,#0d1e1a,#091016);transform:rotateY(180deg);}
.c-tag{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:14px;font-family:'JetBrains Mono',monospace;}
.c-word{font-family:'Sora',sans-serif;font-size:38px;font-weight:800;color:var(--blue);text-align:center;line-height:1.1;letter-spacing:-1px;}
.c-ph{font-size:14px;color:var(--purple);margin-top:8px;font-family:'JetBrains Mono',monospace;}
.c-type{font-size:11px;color:var(--text3);margin-top:4px;font-style:italic;}
.c-part{font-size:11px;background:rgba(59,130,246,.15);color:var(--blue2);padding:2px 8px;border-radius:6px;margin-top:6px;font-family:'JetBrains Mono',monospace;}
.c-def{font-size:16px;color:var(--text);text-align:center;line-height:1.6;font-weight:500;}
.c-ex{font-size:12px;color:var(--text2);font-style:italic;text-align:center;margin-top:10px;line-height:1.7;padding:0 10px;}
.c-vn{font-size:14px;color:var(--teal);margin-top:8px;font-weight:600;}
.c-hint{font-size:10px;color:var(--border2);margin-top:10px;letter-spacing:1px;}
.speak-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:20px;border:1px solid var(--border);background:rgba(20,24,36,.8);color:var(--text2);cursor:pointer;font-size:11px;font-family:'Sora',sans-serif;transition:all .2s;margin-top:10px;}
.speak-btn:hover,.speak-btn.speaking{border-color:var(--teal);color:var(--teal);}
.speak-btn.speaking{animation:pls .8s ease infinite;}
@keyframes pls{0%,100%{box-shadow:0 0 0 0 rgba(20,184,166,.3);}50%{box-shadow:0 0 0 6px rgba(20,184,166,0);}}
.wave{display:flex;gap:2px;align-items:center;height:13px;}
.wave span{display:block;width:2px;background:currentColor;border-radius:2px;height:5px;}
.speaking .wave span:nth-child(1){animation:bar .6s 0s ease infinite;}
.speaking .wave span:nth-child(2){animation:bar .6s .15s ease infinite;}
.speaking .wave span:nth-child(3){animation:bar .6s .3s ease infinite;}
@keyframes bar{0%,100%{height:4px;}50%{height:12px;}}
.rating-area{display:none;}.rating-area.show{display:block;}
.r-lbl{font-size:11px;color:var(--text2);text-align:center;margin-bottom:11px;letter-spacing:2px;text-transform:uppercase;}
.r-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.r-btn{flex:1;min-width:80px;max-width:130px;padding:12px 7px;border:1px solid transparent;border-radius:12px;cursor:pointer;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;transition:all .15s;text-align:center;}
.r-em{font-size:17px;display:block;margin-bottom:3px;}
.r-nx{display:block;font-size:10px;font-weight:400;margin-top:2px;opacity:.7;font-family:'JetBrains Mono',monospace;}
.r-again{background:#1a0808;border-color:rgba(239,68,68,.4);color:var(--red);}
.r-hard{background:#1a1508;border-color:rgba(245,158,11,.4);color:var(--amber);}
.r-good{background:#081020;border-color:rgba(59,130,246,.4);color:var(--blue2);}
.r-easy{background:#081a10;border-color:rgba(34,197,94,.4);color:var(--green);}
.done-box{text-align:center;padding:54px 20px;}
.done-box .big{font-size:50px;margin-bottom:13px;}
.done-box h3{font-size:22px;font-weight:800;margin-bottom:8px;color:var(--green);}
.done-box p{color:var(--text2);font-size:14px;line-height:1.7;}

/* SPELLING STEP */
#spelling-screen{display:none;}
.spell-tag{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;text-align:center;}
.spell-listen{background:linear-gradient(135deg,#0f1825,#0a1020);border:1px solid var(--border);border-radius:18px;padding:30px 20px;text-align:center;margin-bottom:18px;}
.spell-listen-icon{font-size:46px;margin-bottom:10px;}
.spell-listen-lbl{font-size:14px;color:var(--text2);margin-bottom:14px;}
.spell-opts{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:16px;}
.spell-opt{padding:14px 12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;text-align:center;color:var(--text);transition:all .15s;}
.spell-opt:hover:not(.disabled){border-color:var(--blue);background:var(--surface2);}
.spell-opt.correct{border-color:var(--green)!important;background:#091a0f!important;color:var(--green)!important;}
.spell-opt.wrong{border-color:var(--red)!important;background:#1a0808!important;color:var(--red)!important;animation:shake .3s ease;}
.spell-opt.disabled{cursor:default;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-6px);}75%{transform:translateX(6px);}}

/* QUIZ */
.quiz-stats{display:flex;gap:10px;margin-bottom:20px;}
.q-stat{flex:1;background:var(--surface);border-radius:12px;padding:12px;text-align:center;border:1px solid var(--border);}
.q-stat-num{font-size:22px;font-weight:800;font-family:'Sora',sans-serif;}
.q-stat-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-top:2px;}
.qtype-tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.qtype-btn{flex:1;min-width:120px;padding:9px 8px;border-radius:9px;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;font-family:'Sora',sans-serif;font-size:11px;font-weight:600;transition:all .15s;white-space:nowrap;}
.qtype-btn.active{background:var(--blue);border-color:var(--blue);color:#fff;}
.quiz-q-card{background:var(--surface);border-radius:var(--radius);padding:24px;border:1px solid var(--border);margin-bottom:16px;}
.q-type-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;font-family:'JetBrains Mono',monospace;}
.toeic-part-lbl{display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:12px;}
.part5-lbl{background:rgba(139,92,246,.2);color:var(--purple);}
.part6-lbl{background:rgba(245,158,11,.2);color:var(--amber);}
.part7-lbl{background:rgba(20,184,166,.2);color:var(--teal);}
.q-word{font-size:30px;font-weight:800;color:var(--blue);margin-bottom:6px;font-family:'Sora',sans-serif;letter-spacing:-1px;}
.q-ph{font-size:13px;color:var(--purple);font-family:'JetBrains Mono',monospace;}
.blank-sent{font-size:16px;color:var(--text);line-height:1.9;text-align:left;padding:14px;background:var(--surface2);border-radius:10px;margin-top:10px;}
.blank{display:inline-block;min-width:100px;border-bottom:2px solid var(--blue);color:var(--blue2);font-weight:700;font-family:'JetBrains Mono',monospace;font-size:18px;text-align:center;padding:0 5px;}
.quiz-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.q-opt{padding:12px 15px;background:var(--surface);border:1px solid var(--border);border-radius:11px;cursor:pointer;font-family:'Sora',sans-serif;font-size:13px;line-height:1.5;transition:all .15s;text-align:left;color:var(--text);position:relative;}
.q-opt:hover:not(.disabled){border-color:var(--blue);background:var(--surface2);}
.q-opt.correct{border-color:var(--green)!important;background:#091a0f!important;color:var(--green)!important;font-weight:600;}
.q-opt.wrong{border-color:var(--red)!important;background:#1a0808!important;color:var(--red)!important;}
.q-opt.reveal{border-color:var(--green)!important;background:#091a0f!important;color:var(--green)!important;font-weight:600;animation:pc .4s ease;}
@keyframes pc{0%,100%{transform:scale(1);}50%{transform:scale(1.02);}}
.q-opt.disabled{cursor:default;opacity:.75;}
.opt-letter{display:inline-block;width:22px;height:22px;border-radius:50%;border:1px solid currentColor;text-align:center;line-height:20px;font-size:11px;font-weight:700;margin-right:8px;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
.q-opt-inner{display:flex;align-items:flex-start;}
.quiz-next-btn{display:none!important;}

/* PASSAGE TYPE (Part 6/7) */
.passage-box{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px;font-size:14px;line-height:1.9;color:var(--text);}
.passage-box p{margin-bottom:10px;}
.passage-box p:last-child{margin-bottom:0;}
.passage-ctx{font-size:11px;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;}

/* PROGRESS */
.prog-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px;}
.prog-card{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);}
.prog-num{font-size:36px;font-weight:800;line-height:1;font-family:'Sora',sans-serif;}
.prog-lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;margin-top:5px;}
.pc1 .prog-num{color:#7eb8f7;}.pc2 .prog-num{color:var(--purple);}.pc3 .prog-num{color:var(--amber);}.pc4 .prog-num{color:var(--green);}
.donut-wrap{display:flex;justify-content:center;margin:18px 0;}
svg.donut{transform:rotate(-90deg);}
.donut-ring{fill:none;stroke-width:16;}
.streak-box{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);}
.streak-lbl{font-size:12px;font-weight:600;margin-bottom:13px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.streak-days{display:flex;gap:4px;flex-wrap:wrap;}
.day{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--text3);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;}
.day.ok{background:var(--blue);color:#fff;border-color:var(--blue);font-weight:700;}

/* ADMIN */
.login-wrap{max-width:340px;margin:80px auto;text-align:center;}
.login-wrap h2{font-size:22px;font-weight:700;margin-bottom:20px;}
.login-wrap input{margin-bottom:14px;text-align:center;letter-spacing:4px;font-size:17px;font-family:'JetBrains Mono',monospace;}
.login-err{color:var(--red);font-size:13px;margin-top:8px;display:none;}
.admin-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px;}
.admin-title{font-size:20px;font-weight:700;color:var(--blue);}
.a-tabs{display:flex;gap:5px;background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:5px;margin-bottom:22px;}
.a-tab{flex:1;padding:9px 10px;border:none;border-radius:8px;cursor:pointer;font-family:'Sora',sans-serif;font-size:12px;background:transparent;color:var(--text2);transition:all .2s;font-weight:600;}
.a-tab.active{background:var(--blue);color:#fff;}
.a-screen{display:none;}.a-screen.active{display:block;}
.t-row{display:flex;align-items:center;gap:10px;background:var(--surface);border-radius:12px;padding:13px 15px;border:1px solid var(--border);margin-bottom:9px;}
.t-row-info{flex:1;}
.t-row-name{font-weight:700;font-size:14px;}
.t-row-count{font-size:11px;color:var(--text2);margin-top:2px;}
.form-2{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.form-3{display:grid;grid-template-columns:56px 1fr 90px;gap:11px;}
.w-table{width:100%;border-collapse:collapse;margin-top:14px;}
.w-table th{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text2);padding:8px 11px;text-align:left;border-bottom:1px solid var(--border);}
.w-table td{padding:10px 11px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text);}
.w-table tr:last-child td{border-bottom:none;}
.w-table tr:hover td{background:var(--surface2);}
.csv-drop{border:2px dashed var(--border);border-radius:12px;padding:26px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--surface);}
.csv-drop:hover,.csv-drop.over{border-color:var(--blue);background:rgba(59,130,246,.05);}
.csv-drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.section-title{font-size:20px;font-weight:700;}

/* FILL-BLANK */
.fb-blank{display:inline-block;min-width:90px;padding:2px 8px;margin:0 4px;border-bottom:2px solid var(--blue);color:var(--blue2);font-weight:700;cursor:pointer;transition:all .2s;vertical-align:baseline;font-family:'JetBrains Mono',monospace;}
.fb-blank:hover{background:var(--surface2);}
.fb-blank.filled{color:var(--teal);border-color:var(--teal);}
.fb-word{display:inline-block;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;transition:all .15s;user-select:none;font-family:'JetBrains Mono',monospace;}
.fb-word:hover{border-color:var(--blue);transform:translateY(-1px);}
.fb-word.used{opacity:.25;cursor:not-allowed;pointer-events:none;}

/* TOEIC-specific question context */
.q-context-header{font-size:12px;color:var(--text3);margin-bottom:8px;display:flex;align-items:center;gap:8px;}
.q-context-header::before{content:'';display:block;width:3px;height:14px;background:var(--blue);border-radius:2px;}

@media(max-width:600px){
  .c-word{font-size:28px;}.quiz-opts{grid-template-columns:1fr;}
  .prog-grid{grid-template-columns:1fr 1fr;}.form-2,.form-3{grid-template-columns:1fr;}
  header{flex-direction:column;align-items:flex-start;}
  .qtype-tabs{flex-direction:column;}
  .qtype-btn{min-width:auto;}
}

/* PART 7 Reading passage style */
.reading-passage{background:var(--surface2);border-left:3px solid var(--blue);padding:14px 16px;border-radius:0 10px 10px 0;margin-bottom:14px;font-size:13px;line-height:1.9;}
.reading-passage .p-title{font-size:12px;color:var(--blue2);font-weight:700;margin-bottom:8px;letter-spacing:1px;text-transform:uppercase;}

/* AI explain box */
#ai-explain-box{display:none;margin-top:12px;font-size:13px;color:var(--text2);line-height:1.7;text-align:left;background:var(--surface2);border-radius:10px;padding:12px 14px;}
</style>
</head>
<body>

<div id="overlay">
  <div class="ov-logo">TOEIC <span>Vocab</span></div>
  <div class="spinner" style="margin-top:6px;width:24px;height:24px;border-width:3px;"></div>
  <div class="ov-msg" id="ov-msg">Äang khá»Ÿi Ä‘á»™ng...</div>
</div>

<div id="app" style="display:none">

<!-- SETUP -->
<div id="screen-setup" class="screen">
  <div class="setup-wrap">
    <div class="card">
      <div style="font-size:36px;margin-bottom:12px;text-align:center">âš™ï¸</div>
      <h2 style="text-align:center">CÃ i Ä‘áº·t láº§n Ä‘áº§u</h2>
      <p style="text-align:center">Káº¿t ná»‘i JSONBin Ä‘á»ƒ lÆ°u tá»« vá»±ng TOEIC trÃªn cloud â€” há»c sinh trÃªn má»i thiáº¿t bá»‹ Ä‘á»u tháº¥y cÃ¹ng ná»™i dung.</p>
      <div class="setup-field"><label>JSONBin Secret Key</label><input id="s-key" type="text" placeholder="$2b$10$..."></div>
      <div class="setup-field"><label>Anthropic API Key <span style="color:var(--text2);font-weight:400;text-transform:none;font-size:12px">(tuá»³ chá»n â€” Ä‘á»ƒ dÃ¹ng AI)</span></label><input id="s-claude" type="text" placeholder="sk-ant-..."></div>
      <div class="setup-field"><label>Máº­t kháº©u Admin</label><input id="s-pwd" type="password" placeholder="Äáº·t máº­t kháº©u báº£o máº­t"></div>
      <button class="btn btn-p" style="width:100%;justify-content:center;margin-top:6px" onclick="doSetup()">
        <span id="setup-btn-txt">HoÃ n táº¥t cÃ i Ä‘áº·t â†’</span>
      </button>
      <div id="setup-err" style="color:var(--red);font-size:13px;margin-top:10px;display:none;text-align:center"></div>
      <div class="api-note">
        ğŸ“Œ <strong>CÃ¡ch láº¥y JSONBin Key (miá»…n phÃ­):</strong><br>
        VÃ o <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> â†’ Sign up â†’ Dashboard â†’ API Keys â†’ copy <strong>Secret Access Key</strong><br><br>
        ğŸ¤– <strong>Anthropic API Key:</strong> <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> â†’ API Keys
      </div>
    </div>
  </div>
</div>

<!-- STUDENT APP -->
<div id="student-app" style="display:none">
  <header>
    <div class="logo-area">
      <span class="logo-text">TOEIC</span>
      <span class="logo-badge">VOCAB</span>
    </div>
    <div class="hstats">
      <div class="hstat"><div class="hstat-num" id="h-total">0</div><div class="hstat-lbl">Tá»«</div></div>
      <div class="hstat"><div class="hstat-num" id="h-due">0</div><div class="hstat-lbl">HÃ´m nay</div></div>
      <div class="hstat"><div class="hstat-num" id="h-mastered">0</div><div class="hstat-lbl">Thuá»™c</div></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="sync-btn" class="admin-gear" onclick="manualSync()" title="Äá»“ng bá»™" style="display:none;">ğŸ”„</button>
      <button class="admin-gear" onclick="showLoginScreen()" title="Admin">âš™</button>
    </div>
  </header>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('topics')">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="tab-btn" onclick="switchTab('study')">ğŸ§  Há»c</button>
    <button class="tab-btn" onclick="switchTab('quiz')">âš¡ Quiz</button>
    <button class="tab-btn" onclick="switchTab('progress')">ğŸ“Š Tiáº¿n Ä‘á»™</button>
  </div>

  <!-- Topics -->
  <div id="screen-topics" class="screen active">
    <div id="topic-list-view">
      <div style="margin-bottom:18px"><span class="section-title">ğŸ—‚ Chá»§ Ä‘á» TOEIC</span></div>
      <div class="topic-grid" id="topic-grid"></div>
    </div>
    <div id="topic-detail-view" style="display:none">
      <div class="detail-hdr">
        <button class="back-btn" onclick="backToList()">â† Quay láº¡i</button>
        <span class="detail-title" id="det-title"></span>
        <span class="detail-badge" id="det-badge"></span>
      </div>
      <div class="chip-grid" id="chip-grid"></div>
      <div class="topic-actions">
        <button class="btn btn-p" onclick="studyThis()">ğŸ§  Há»c chá»§ Ä‘á» nÃ y</button>
        <button class="btn btn-s" onclick="quizThis()">âš¡ Quiz TOEIC</button>
      </div>
    </div>
  </div>

  <!-- Study -->
  <div id="screen-study" class="screen">
    <div id="study-main">
      <div class="study-hdr">
        <span id="study-lbl" style="font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace;">SPACED REPETITION</span>
        <div class="prg-wrap"><div class="prg-fill" id="study-bar" style="width:0%"></div></div>
        <span class="study-cnt" id="study-cnt">0/0</span>
      </div>
      <!-- Spelling step -->
      <div id="spelling-screen">
        <div class="spell-tag">BÆ¯á»šC 1 / 2 â€” NHáº¬N Dáº NG Tá»ª</div>
        <div class="spell-listen">
          <div class="spell-listen-icon">ğŸ§</div>
          <div class="spell-listen-lbl">Nghe vÃ  chá»n tá»« Ä‘Ãºng chÃ­nh táº£</div>
          <button class="speak-btn" onclick="speakCurrent()" style="margin:0 auto"><span class="wave"><span></span><span></span><span></span></span> Nghe láº¡i</button>
          <div class="spell-listen-ph" id="spell-ph" style="font-size:13px;color:var(--purple);margin-top:8px;font-family:'JetBrains Mono',monospace;"></div>
          <div style="font-size:11px;color:var(--text3);font-style:italic;margin-top:4px;" id="spell-type"></div>
        </div>
        <div class="spell-opts" id="spell-opts"></div>
        <div id="spell-feedback" style="display:none;text-align:center;padding:10px;font-size:14px;color:var(--green)"></div>
      </div>

      <div class="card-wrap" id="card-wrap-main">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="card-face cf">
            <div class="c-tag">Tá»ª Vá»°NG TOEIC</div>
            <div class="c-word" id="cf-word">â€”</div>
            <div class="c-ph" id="cf-ph"></div>
            <div class="c-type" id="cf-type"></div>
            <div class="c-part" id="cf-part" style="display:none"></div>
            <button class="speak-btn" onclick="event.stopPropagation();speakCurrent()"><span class="wave"><span></span><span></span><span></span></span> PhÃ¡t Ã¢m</button>
            <div class="c-hint">Click Ä‘á»ƒ xem Ä‘á»‹nh nghÄ©a</div>
          </div>
          <div class="card-face cb">
            <div class="c-tag">Äá»ŠNH NGHÄ¨A & VÃ Dá»¤ TOEIC</div>
            <div class="c-def" id="cb-def"></div>
            <div class="c-vn" id="cb-vn"></div>
            <div class="c-ex" id="cb-ex"></div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center">
              <button class="speak-btn" onclick="event.stopPropagation();speakCurrent()"><span class="wave"><span></span><span></span><span></span></span> Nghe láº¡i</button>
              <button class="speak-btn" id="ai-explain-btn" onclick="event.stopPropagation();aiExplain()" style="border-color:var(--blue);color:var(--blue2)">ğŸ¤– AI giáº£i thÃ­ch</button>
            </div>
            <div id="ai-explain-box"></div>
          </div>
        </div>
      </div>

      <div class="rating-area" id="rating-area">
        <div class="r-lbl">Báº¡n nhá»› tá»« nÃ y á»Ÿ má»©c nÃ o?</div>
        <div class="r-btns">
          <button class="r-btn r-again" onclick="rate(0)"><span class="r-em">ğŸ˜°</span>QuÃªn rá»“i<span class="r-nx" id="nx0"></span></button>
          <button class="r-btn r-hard"  onclick="rate(1)"><span class="r-em">ğŸ˜…</span>KhÃ³<span class="r-nx" id="nx1"></span></button>
          <button class="r-btn r-good"  onclick="rate(2)"><span class="r-em">ğŸ˜Š</span>Nhá»› Ä‘Æ°á»£c<span class="r-nx" id="nx2"></span></button>
          <button class="r-btn r-easy"  onclick="rate(3)"><span class="r-em">ğŸ‰</span>Dá»… quÃ¡!<span class="r-nx" id="nx3"></span></button>
        </div>
      </div>
    </div>
    <div class="done-box" id="study-done" style="display:none">
      <div class="big">ğŸ‰</div>
      <h3>HoÃ n thÃ nh!</h3>
      <p>Báº¡n Ä‘Ã£ Ã´n xong hÃ´m nay.<br>Quay láº¡i ngÃ y mai Ä‘á»ƒ tiáº¿p tá»¥c!</p><br>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-p" onclick="switchTab('progress')">Xem tiáº¿n Ä‘á»™ â†’</button>
        <button class="btn btn-s" id="study-all-btn" style="display:none" onclick="clearFilter()">ğŸ“š Há»c táº¥t cáº£ tá»«</button>
      </div>
    </div>
  </div>

  <!-- Quiz -->
  <div id="screen-quiz" class="screen">
    <div class="quiz-stats">
      <div class="q-stat"><div class="q-stat-num" id="qc" style="color:var(--green)">0</div><div class="q-stat-lbl">ÄÃºng</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qw" style="color:var(--red)">0</div><div class="q-stat-lbl">Sai</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qt" style="color:var(--blue)">0</div><div class="q-stat-lbl">Tá»•ng</div></div>
      <div class="q-stat"><div class="q-stat-num" id="qa" style="color:var(--teal)">â€”</div><div class="q-stat-lbl">ChÃ­nh xÃ¡c</div></div>
    </div>
    <div id="quiz-main">
      <div class="qtype-tabs">
        <button class="qtype-btn active" id="qt-part5"    onclick="setQType('part5')">ğŸ“ Part 5 â€“ Chá»n tá»«</button>
        <button class="qtype-btn" id="qt-part6"           onclick="setQType('part6')">ğŸ“„ Part 6 â€“ Äiá»n Ä‘oáº¡n</button>
        <button class="qtype-btn" id="qt-meaning"         onclick="setQType('meaning')">ğŸ“– Chá»n nghÄ©a</button>
        <button class="qtype-btn" id="qt-random"          onclick="setQType('random')">ğŸ² Random</button>
      </div>

      <div class="quiz-q-card" id="quiz-q-card">
        <div class="q-type-lbl" id="q-lbl">TOEIC Part 5</div>
        <div class="toeic-part-lbl part5-lbl" id="q-part-badge">Part 5 â€“ Incomplete Sentences</div>
        <div class="q-word" id="q-word" style="display:none">â€”</div>
        <div class="q-ph" id="q-ph" style="display:none"></div>
        <!-- Context sentence or passage -->
        <div class="blank-sent" id="q-sent" style="display:none"></div>
        <!-- Part 6 passage -->
        <div class="reading-passage" id="q-passage" style="display:none">
          <div class="p-title" id="q-passage-title">Memo</div>
          <div id="q-passage-text"></div>
        </div>
        <button class="speak-btn" id="q-speak-btn" onclick="speakWord(currentQWord)" style="margin-top:8px;display:none"><span class="wave"><span></span><span></span><span></span></span> PhÃ¡t Ã¢m</button>
      </div>
      <div class="quiz-opts" id="quiz-opts"></div>

      <!-- Fill blank word bank (Part 6) -->
      <div id="fillblank-ex" style="display:none">
        <div style="margin-bottom:12px">
          <div style="font-size:11px;color:var(--text3);margin-bottom:8px;letter-spacing:1px;text-transform:uppercase;font-family:'JetBrains Mono',monospace;">Chá»n tá»« Ä‘á»ƒ Ä‘iá»n:</div>
          <div id="fb-wordbank" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center">
          <button class="btn btn-p" onclick="checkFillBlank()">âœ“ Kiá»ƒm tra</button>
          <button class="btn btn-s" onclick="resetFillBlank()">â†» LÃ m láº¡i</button>
        </div>
        <div id="fb-feedback" style="display:none;margin-top:14px;padding:14px;border-radius:12px;font-size:14px;line-height:1.6"></div>
      </div>
      <button class="quiz-next-btn" id="quiz-next" onclick="nextQ()">CÃ¢u tiáº¿p theo â†’</button>
    </div>
    <div id="quiz-empty" style="display:none;text-align:center;padding:56px 20px;color:var(--text2)">
      <div style="font-size:42px;margin-bottom:12px">ğŸ“š</div>
      <p>Chá»n má»™t chá»§ Ä‘á» Ä‘á»ƒ báº¯t Ä‘áº§u quiz!</p><br>
      <button class="btn btn-p" onclick="switchTab('topics')">Chá»n chá»§ Ä‘á»</button>
    </div>
  </div>

  <!-- Progress -->
  <div id="screen-progress" class="screen">
    <div class="prog-grid">
      <div class="prog-card pc1"><div class="prog-num" id="p-new">0</div><div class="prog-lbl">ğŸ†• Má»›i</div></div>
      <div class="prog-card pc2"><div class="prog-num" id="p-learn">0</div><div class="prog-lbl">ğŸ“– Äang há»c</div></div>
      <div class="prog-card pc3"><div class="prog-num" id="p-rev">0</div><div class="prog-lbl">ğŸ”„ Cáº§n Ã´n</div></div>
      <div class="prog-card pc4"><div class="prog-num" id="p-master">0</div><div class="prog-lbl">âœ… Thuá»™c</div></div>
    </div>
    <div style="text-align:center;margin:6px 0 18px">
      <div class="donut-wrap">
        <svg class="donut" width="140" height="140" viewBox="0 0 160 160">
          <circle class="donut-ring" cx="80" cy="80" r="62" stroke="#141c2c"/>
          <circle class="donut-ring" id="donut" cx="80" cy="80" r="62" stroke="#22c55e" stroke-dasharray="0 390" stroke-linecap="round"/>
        </svg>
      </div>
      <div style="font-size:16px;color:var(--text2);margin-top:-4px">
        <span id="pct" style="font-size:28px;color:var(--green);font-weight:800">0%</span> Ä‘Ã£ thuá»™c
      </div>
    </div>
    <div class="streak-box">
      <div class="streak-lbl">ğŸ“… Lá»‹ch sá»­ há»c (30 ngÃ y)</div>
      <div class="streak-days" id="streak"></div>
    </div>
  </div>
</div><!-- /student-app -->

<!-- ADMIN LOGIN -->
<div id="screen-login" class="screen">
  <div class="login-wrap">
    <div class="card">
      <div style="font-size:34px;margin-bottom:8px;text-align:center">ğŸ”</div>
      <h2>Admin Login</h2>
      <input id="login-pwd" type="password" placeholder="Máº­t kháº©u" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="btn btn-p" style="width:100%;justify-content:center" onclick="doLogin()">ÄÄƒng nháº­p</button>
      <div class="login-err" id="login-err">Sai máº­t kháº©u!</div><br>
      <button class="btn btn-s btn-sm" onclick="toStudent()">â† Quay láº¡i</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="screen-admin" class="screen">
  <div class="admin-hdr">
    <div style="display:flex;align-items:center;gap:12px;">
      <span class="admin-title">âš™ï¸ Admin Panel</span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-p btn-sm" onclick="copyShareLink()">ğŸ”— Link há»c sinh</button>
      <button class="btn btn-s btn-sm" onclick="toStudent()">â† ThoÃ¡t</button>
      <button class="btn btn-d btn-sm" onclick="doLogout()">ÄÄƒng xuáº¥t</button>
    </div>
  </div>
  <div class="a-tabs">
    <button class="a-tab active" onclick="switchATab('topics',this)">ğŸ—‚ Chá»§ Ä‘á»</button>
    <button class="a-tab" onclick="switchATab('words',this)">ğŸ“ Tá»« vá»±ng</button>
    <button class="a-tab" onclick="switchATab('import',this)">ğŸ“¥ Import CSV</button>
    <button class="a-tab" onclick="switchATab('aigen',this)">âœ¨ AI Generate</button>
  </div>

  <div id="a-topics" class="a-screen active">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <span style="font-weight:600">Danh sÃ¡ch chá»§ Ä‘á» TOEIC</span>
      <button class="btn btn-p btn-sm" onclick="openTopicForm()">ï¼‹ ThÃªm chá»§ Ä‘á»</button>
    </div>
    <div id="a-topic-list"></div>
    <div id="topic-form" class="card" style="display:none;margin-top:14px">
      <div style="font-weight:700;margin-bottom:14px" id="tf-title">ThÃªm chá»§ Ä‘á» má»›i</div>
      <div class="form-3" style="margin-bottom:11px">
        <div><label>Icon</label><input id="tf-emoji" type="text" maxlength="2" value="ğŸ’¼" style="text-align:center;font-size:20px;padding:8px"></div>
        <div><label>TÃªn chá»§ Ä‘á»</label><input id="tf-name" type="text" placeholder="VD: Business Meeting"></div>
        <div><label>MÃ u</label><input id="tf-color" type="color" value="#3b82f6" style="height:42px;padding:4px 8px;cursor:pointer;width:100%"></div>
      </div>
      <div style="display:flex;gap:9px;margin-top:6px">
        <button class="btn btn-p" onclick="saveTopic()">ğŸ’¾ LÆ°u</button>
        <button class="btn btn-s" onclick="closeTopicForm()">Huá»·</button>
      </div>
    </div>
  </div>

  <div id="a-words" class="a-screen">
    <div style="margin-bottom:13px"><label>Chá»n chá»§ Ä‘á»</label>
      <select id="a-topic-sel" onchange="loadWords()"></select>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:11px">
      <span style="font-size:13px;color:var(--text2)" id="word-count-lbl"></span>
      <button class="btn btn-p btn-sm" onclick="openWordForm()">ï¼‹ ThÃªm tá»«</button>
    </div>
    <div id="word-form" class="card" style="display:none;margin-bottom:14px">
      <div style="font-weight:700;margin-bottom:13px">ThÃªm tá»« má»›i</div>
      <div class="form-2" style="margin-bottom:10px">
        <div><label>Tá»« / cá»¥m tá»« *</label><input id="wf-word" placeholder="VD: negotiate"></div>
        <div><label>PhiÃªn Ã¢m</label><input id="wf-ph" placeholder="/nÉªËˆÉ¡oÊŠ.Êƒi.eÉªt/"></div>
      </div>
      <div class="form-2" style="margin-bottom:10px">
        <div><label>Loáº¡i tá»«</label><input id="wf-type" placeholder="v / n / adj / adv / phrase"></div>
        <div><label>NghÄ©a tiáº¿ng Viá»‡t</label><input id="wf-vn" placeholder="Ä‘Ã m phÃ¡n"></div>
      </div>
      <div style="margin-bottom:10px"><label>Äá»‹nh nghÄ©a tiáº¿ng Anh</label><input id="wf-def" placeholder="to discuss to reach an agreement"></div>
      <div style="margin-bottom:13px"><label>CÃ¢u vÃ­ dá»¥ (style TOEIC)</label><input id="wf-ex" placeholder="The managers will negotiate the contract terms tomorrow."></div>
      <div style="display:flex;gap:9px">
        <button class="btn btn-p" onclick="saveWord()">ğŸ’¾ LÆ°u tá»«</button>
        <button class="btn btn-s" onclick="closeWordForm()">Huá»·</button>
      </div>
    </div>
    <table class="w-table">
      <thead><tr><th>Tá»«</th><th>PhiÃªn Ã¢m</th><th>NghÄ©a VN</th><th>Definition</th><th></th></tr></thead>
      <tbody id="word-tbody"></tbody>
    </table>
  </div>

  <div id="a-import" class="a-screen">
    <div class="card" style="margin-bottom:16px">
      <div style="font-weight:700;margin-bottom:6px">ğŸ“¥ Import CSV</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:14px">Format: <span style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--blue2)">word, phonetic, type, definition, example, vietnamese</span></div>
      <div style="margin-bottom:11px"><label>ThÃªm vÃ o chá»§ Ä‘á»</label><select id="import-topic-sel"></select></div>
      <div class="csv-drop" id="csv-drop">
        <input type="file" accept=".csv" onchange="handleCSV(this)">
        <div style="font-size:28px;margin-bottom:8px">ğŸ“‚</div>
        <div style="font-size:14px;color:var(--text2)">KÃ©o tháº£ file CSV vÃ o Ä‘Ã¢y hoáº·c click Ä‘á»ƒ chá»n</div>
      </div>
      <div id="import-result" style="display:none;margin-top:14px;font-size:14px;color:var(--green)"></div>
    </div>
  </div>

  <div id="a-aigen" class="a-screen">
    <div class="card" style="margin-bottom:16px">
      <div style="font-weight:700;margin-bottom:6px;font-size:15px">âœ¨ Táº¡o tá»« vá»±ng TOEIC báº±ng AI</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:16px">Claude sáº½ táº¡o tá»« vá»±ng TOEIC vá»›i vÃ­ dá»¥ vÃ  cÃ¢u há»i theo Ä‘Ãºng chuáº©n Ä‘á» thi</div>
      <div style="margin-bottom:11px"><label>ThÃªm vÃ o chá»§ Ä‘á»</label><select id="aigen-topic-sel"></select></div>
      <div style="margin-bottom:11px"><label>Chá»§ Ä‘á» / yÃªu cáº§u</label>
        <input id="aigen-topic-input" placeholder="VD: Office communication, Business travel, Finance &amp; Banking...">
      </div>
      <div style="margin-bottom:14px"><label>Sá»‘ lÆ°á»£ng tá»«</label>
        <select id="aigen-count" style="width:auto">
          <option value="10">10 tá»«</option>
          <option value="20" selected>20 tá»«</option>
          <option value="30">30 tá»«</option>
          <option value="40">40 tá»«</option>
        </select>
      </div>
      <button class="btn btn-p" onclick="aiGenerate()" id="aigen-btn">âœ¨ Táº¡o tá»« vá»±ng TOEIC</button>
      <div id="aigen-no-key" style="display:none;margin-top:12px;font-size:13px;color:var(--red)">
        âš ï¸ ChÆ°a cÃ³ Anthropic API key. VÃ o <strong>CÃ i Ä‘áº·t</strong> Ä‘á»ƒ thÃªm.
      </div>
    </div>
    <div id="aigen-result" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <span style="font-weight:600" id="aigen-result-count">0 tá»«</span>
        <button class="btn btn-p btn-sm" onclick="aiSaveWords()">ğŸ’¾ LÆ°u vÃ o chá»§ Ä‘á»</button>
      </div>
      <table class="w-table">
        <thead><tr><th>Tá»«</th><th>PhiÃªn Ã¢m</th><th>NghÄ©a VN</th><th>Definition</th></tr></thead>
        <tbody id="aigen-tbody"></tbody>
      </table>
    </div>
  </div>
</div><!-- /screen-admin -->

</div><!-- /app -->

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JSONBIN_URL = 'https://api.jsonbin.io/v3/b';
const CLAUDE_URL = 'https://api.anthropic.com/v1/messages';
const CFG_KEY = 'toeicvocab_cfg';
const PROG_KEY = 'toeicvocab_prog';

let CFG = {}; // {binId, binKey, claudeKey, adminPwd}
let CLOUD = {}; // {topics:[...]}
let PROG = {}; // word progress: {wordKey: {status,due,ef,interval,reps}}
let currentWord = null, currentTopicId = null;
let studyQueue = [], studyIdx = 0, cardFlipped = false;
let quizCorrect=0, quizWrong=0, quizTotal=0;
let currentQType = 'part5';
let currentQWord = '';
let fbAnswers = {}, fbCorrect = {};
let editTopicId = null, editWordIdx = null;
let aiGenBuffer = [];
let isSpelling = false;
const TOEIC_PARTS = ['Part 5 â€“ Incomplete Sentences', 'Part 6 â€“ Text Completion', 'Part 7 â€“ Reading Comprehension'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  CFG = loadJson(CFG_KEY, {});
  PROG = loadJson(PROG_KEY, {});
  if(!CFG.binKey){ showScreen('screen-setup'); hideOverlay(); return; }
  setMsg('Äang táº£i dá»¯ liá»‡u...');
  try { await syncCloud(); } catch(e){ CLOUD = {topics:[]}; }
  loadProgress();
  showStudent();
  hideOverlay();
}

function hideOverlay(){ document.getElementById('overlay').classList.add('hidden'); document.getElementById('app').style.display=''; }
function setMsg(m){ document.getElementById('ov-msg').textContent = m; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSetup(){
  const key = document.getElementById('s-key').value.trim();
  const claude = document.getElementById('s-claude').value.trim();
  const pwd = document.getElementById('s-pwd').value.trim();
  const err = document.getElementById('setup-err');
  if(!key||!pwd){ err.style.display='block'; err.textContent='Nháº­p Ä‘á»§ JSONBin Key vÃ  máº­t kháº©u!'; return; }
  document.getElementById('setup-btn-txt').innerHTML='<span class="spinner"></span>';
  try {
    const res = await fetch(JSONBIN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','X-Master-Key':key,'X-Bin-Name':'toeic-vocab','X-Bin-Private':'false'},
      body: JSON.stringify({topics: getDefaultTopics()})
    });
    if(!res.ok) throw new Error('JSONBin error');
    const d = await res.json();
    CFG = {binId: d.metadata.id, binKey: key, claudeKey: claude, adminPwd: pwd};
    saveJson(CFG_KEY, CFG);
    CLOUD = {topics: getDefaultTopics()};
    PROG = {};
    showStudent();
    hideOverlay();
  } catch(e){
    err.style.display='block'; err.textContent='Lá»—i káº¿t ná»‘i JSONBin. Kiá»ƒm tra láº¡i key!';
  }
  document.getElementById('setup-btn-txt').textContent='HoÃ n táº¥t cÃ i Ä‘áº·t â†’';
}

function getDefaultTopics(){
  return [
    {id:'t1',name:'Business Meeting',emoji:'ğŸ’¼',color:'#3b82f6',words:[
      {word:'negotiate',phonetic:'/nÉªËˆÉ¡oÊŠ.Êƒi.eÉªt/',type:'v',definition:'to discuss in order to reach an agreement',example:'The two companies will negotiate the terms of the contract next week.',vietnamese:'Ä‘Ã m phÃ¡n'},
      {word:'agenda',phonetic:'/É™ËˆdÊ’en.dÉ™/',type:'n',definition:'a list of topics to be discussed at a meeting',example:'Please review the agenda before the board meeting tomorrow.',vietnamese:'chÆ°Æ¡ng trÃ¬nh nghá»‹ sá»±'},
      {word:'adjourn',phonetic:'/É™ËˆdÊ’ÉœËrn/',type:'v',definition:'to suspend a meeting to a later time',example:'The chairman decided to adjourn the meeting until next Monday.',vietnamese:'hoÃ£n há»p'},
      {word:'unanimous',phonetic:'/juËˆnÃ¦n.Éª.mÉ™s/',type:'adj',definition:'fully agreed by everyone',example:'The board reached a unanimous decision to expand into new markets.',vietnamese:'nháº¥t trÃ­, Ä‘á»“ng thuáº­n'},
      {word:'minutes',phonetic:'/ËˆmÉªn.Éªts/',type:'n',definition:'a written record of a meeting',example:'The secretary will distribute the minutes of today\'s meeting.',vietnamese:'biÃªn báº£n cuá»™c há»p'},
    ]},
    {id:'t2',name:'Human Resources',emoji:'ğŸ‘¥',color:'#14b8a6',words:[
      {word:'candidate',phonetic:'/ËˆkÃ¦n.dÉª.deÉªt/',type:'n',definition:'a person who applies for a job',example:'We received over 200 applications from qualified candidates.',vietnamese:'á»©ng viÃªn'},
      {word:'probation',phonetic:'/proÊŠËˆbeÉª.ÊƒÉ™n/',type:'n',definition:'a trial period for a new employee',example:'All new staff members are on probation for the first three months.',vietnamese:'thá»i gian thá»­ viá»‡c'},
      {word:'appraisal',phonetic:'/É™ËˆpreÉª.zÉ™l/',type:'n',definition:'an evaluation of employee performance',example:'Annual appraisals help identify training needs.',vietnamese:'Ä‘Ã¡nh giÃ¡ hiá»‡u suáº¥t'},
      {word:'rÃ©sumÃ©',phonetic:'/Ëˆrez.jÊŠ.meÉª/',type:'n',definition:'a document listing work experience and education',example:'Please submit your rÃ©sumÃ© and cover letter by Friday.',vietnamese:'há»“ sÆ¡ xin viá»‡c'},
      {word:'incentive',phonetic:'/ÉªnËˆsen.tÉªv/',type:'n',definition:'something that motivates employees to perform better',example:'The sales team received an incentive bonus for exceeding targets.',vietnamese:'pháº§n thÆ°á»Ÿng khuyáº¿n khÃ­ch'},
    ]},
    {id:'t3',name:'Finance & Banking',emoji:'ğŸ’°',color:'#f59e0b',words:[
      {word:'invoice',phonetic:'/ËˆÉªn.vÉ”Éªs/',type:'n',definition:'a bill for goods or services provided',example:'Please send an invoice to the accounting department.',vietnamese:'hÃ³a Ä‘Æ¡n'},
      {word:'budget',phonetic:'/ËˆbÊŒdÊ’.Éªt/',type:'n/v',definition:'a financial plan; to plan expenditure',example:'The marketing budget was increased by 15% this quarter.',vietnamese:'ngÃ¢n sÃ¡ch'},
      {word:'reimburse',phonetic:'/ËŒriË.ÉªmËˆbÉœËrs/',type:'v',definition:'to pay back money spent on behalf of a company',example:'Submit your receipts and HR will reimburse your travel expenses.',vietnamese:'hoÃ n tiá»n'},
      {word:'revenue',phonetic:'/Ëˆrev.Éª.njuË/',type:'n',definition:'income generated from business operations',example:'Total revenue increased by 20% compared to last year.',vietnamese:'doanh thu'},
      {word:'deficit',phonetic:'/Ëˆdef.Éª.sÉªt/',type:'n',definition:'a shortfall when expenditure exceeds income',example:'The company reported a budget deficit for the second quarter.',vietnamese:'thÃ¢m há»¥t'},
    ]},
    {id:'t4',name:'Office & Administration',emoji:'ğŸ¢',color:'#8b5cf6',words:[
      {word:'correspondence',phonetic:'/ËŒkÉ’r.ÉªËˆspÉ’n.dÉ™ns/',type:'n',definition:'written communication, especially business letters or emails',example:'All correspondence should be forwarded to the manager\'s office.',vietnamese:'thÆ° tá»«, trao Ä‘á»•i vÄƒn báº£n'},
      {word:'submit',phonetic:'/sÉ™bËˆmÉªt/',type:'v',definition:'to present something for consideration or review',example:'Please submit your report by the end of the business day.',vietnamese:'ná»™p, trÃ¬nh'},
      {word:'allocate',phonetic:'/ËˆÃ¦l.É™.keÉªt/',type:'v',definition:'to assign resources for a particular purpose',example:'The manager will allocate tasks to each department.',vietnamese:'phÃ¢n bá»•'},
      {word:'comply',phonetic:'/kÉ™mËˆplaÉª/',type:'v',definition:'to act in accordance with rules or requests',example:'All employees must comply with the new safety regulations.',vietnamese:'tuÃ¢n thá»§'},
      {word:'premises',phonetic:'/Ëˆprem.Éª.sÉªz/',type:'n',definition:'a building and its surrounding area',example:'Smoking is strictly prohibited on company premises.',vietnamese:'khuÃ´n viÃªn, cÆ¡ sá»Ÿ'},
    ]},
  ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOUD SYNC (JSONBin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncCloud(pull=true){
  if(!CFG.binId||!CFG.binKey) return;
  if(pull){
    const res = await fetch(`${JSONBIN_URL}/${CFG.binId}/latest`,{headers:{'X-Master-Key':CFG.binKey}});
    if(!res.ok) throw new Error('sync fail');
    const d = await res.json();
    CLOUD = d.record;
  } else {
    await fetch(`${JSONBIN_URL}/${CFG.binId}`,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':CFG.binKey},body:JSON.stringify(CLOUD)});
  }
}
async function manualSync(){
  const btn=document.getElementById('sync-btn'); btn.disabled=true;
  try { await syncCloud(); renderTopicGrid(); updateHeader(); showToast('âœ… ÄÃ£ Ä‘á»“ng bá»™!'); }
  catch(e){ showToast('âŒ Lá»—i Ä‘á»“ng bá»™'); }
  btn.disabled=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREENS & NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function showStudent(){ document.getElementById('student-app').style.display=''; showScreen('screen-topics'); renderTopicGrid(); updateHeader(); buildStreak(); updateProgress(); }
function toStudent(){ showStudent(); }
function showLoginScreen(){ showScreen('screen-login'); }
function doLogin(){
  if(document.getElementById('login-pwd').value === CFG.adminPwd){
    document.getElementById('login-pwd').value='';
    document.getElementById('login-err').style.display='none';
    showAdminPanel();
  } else {
    document.getElementById('login-err').style.display='block';
  }
}
function doLogout(){ showScreen('screen-login'); }
function showAdminPanel(){
  showScreen('screen-admin');
  renderAdminTopics();
  populateTopicSelects();
}
function copyShareLink(){
  const url = window.location.href.split('?')[0];
  navigator.clipboard.writeText(url).then(()=>showToast('âœ… ÄÃ£ copy link!'));
}
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>{
    b.classList.toggle('active', ['topics','study','quiz','progress'][i]===tab);
  });
  const screens = ['screen-topics','screen-study','screen-quiz','screen-progress'];
  screens.forEach(s=>{ const el=document.getElementById(s); if(el) el.classList.remove('active'); });
  const el = document.getElementById('screen-'+tab);
  if(el){ el.classList.add('active'); }
  if(tab==='study') initStudy();
  if(tab==='quiz') initQuiz();
  if(tab==='progress'){ updateProgress(); buildStreak(); }
}
function switchATab(name, btn){
  document.querySelectorAll('.a-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.a-screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('a-'+name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOPIC GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTopicGrid(){
  const grid = document.getElementById('topic-grid');
  const topics = CLOUD.topics || [];
  grid.innerHTML = topics.map(t => {
    const words = t.words||[];
    const mastered = words.filter(w=>getWProg(t.id,w.word).status==='mastered').length;
    const pct = words.length ? Math.round(mastered/words.length*100) : 0;
    return `<div class="topic-card" style="--tc-color:${t.color||'#3b82f6'}" onclick="openTopic('${t.id}')">
      <div class="t-emoji">${t.emoji||'ğŸ“š'}</div>
      <div class="t-name">${t.name}</div>
      <div class="t-meta">${words.length} tá»«</div>
      <div class="t-bar"><div class="t-bar-fill" style="width:${pct}%;background:${t.color||'#3b82f6'}"></div></div>
      <div class="t-pct">${pct}% thuá»™c</div>
    </div>`;
  }).join('');
}

function openTopic(id){
  currentTopicId = id;
  const t = (CLOUD.topics||[]).find(x=>x.id===id);
  if(!t) return;
  document.getElementById('topic-list-view').style.display='none';
  document.getElementById('topic-detail-view').style.display='block';
  document.getElementById('det-title').textContent = t.emoji+' '+t.name;
  document.getElementById('det-badge').textContent = (t.words||[]).length+' tá»«';
  const grid = document.getElementById('chip-grid');
  grid.innerHTML = (t.words||[]).map((w,i)=>{
    const p = getWProg(id,w.word);
    return `<div class="chip ${p.status==='mastered'?'done':''}" onclick="quickStudy('${id}',${i})">
      <div class="chip-word"><span class="dot s-${p.status||'new'}"></span>${w.word}</div>
      <div class="chip-vn">${w.vietnamese||''}</div>
    </div>`;
  }).join('');
}

function backToList(){
  document.getElementById('topic-list-view').style.display='';
  document.getElementById('topic-detail-view').style.display='none';
  currentTopicId = null;
}
function studyThis(){ switchTab('study'); }
function quizThis(){ switchTab('quiz'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWKey(topicId, word){ return `${topicId}_${word}`; }
function getWProg(topicId, word){
  return PROG[getWKey(topicId,word)] || {status:'new',due:0,ef:2.5,interval:1,reps:0};
}
function setWProg(topicId, word, data){
  PROG[getWKey(topicId,word)] = data;
  saveJson(PROG_KEY, PROG);
}
function loadProgress(){ PROG = loadJson(PROG_KEY, {}); }

// SM-2
function sm2(prog, q){ // q: 0=again, 1=hard, 2=good, 3=easy
  let {ef=2.5, interval=1, reps=0} = prog;
  if(q===0){ reps=0; interval=1; }
  else if(q===1){ reps=0; interval=Math.max(1,Math.round(interval*1.2)); }
  else {
    if(reps===0) interval=1;
    else if(reps===1) interval=6;
    else interval=Math.round(interval*ef);
    reps++;
  }
  ef = Math.max(1.3, ef + 0.1 - (3-q)*(0.08+(3-q)*0.02));
  const now = Date.now();
  const due = now + interval*86400000;
  const status = reps>=4 ? 'mastered' : (reps>=1 ? (q<=1?'review':'learning') : 'new');
  return {ef,interval,reps,due,status};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAllWords(){
  return (CLOUD.topics||[]).flatMap(t=>(t.words||[]).map(w=>({...w,topicId:t.id})));
}
function getStudyQueue(){
  const now = Date.now();
  let words = currentTopicId ? (CLOUD.topics||[]).find(t=>t.id===currentTopicId)?.words?.map(w=>({...w,topicId:currentTopicId}))||[] : getAllWords();
  return words.filter(w=>{ const p=getWProg(w.topicId,w.word); return p.status==='new'||p.due<=now; })
    .sort((a,b)=>{ const pa=getWProg(a.topicId,a.word); const pb=getWProg(b.topicId,b.word); return (pa.due||0)-(pb.due||0); });
}

function initStudy(){
  studyQueue = getStudyQueue();
  studyIdx = 0;
  document.getElementById('study-done').style.display='none';
  document.getElementById('study-main').style.display='';
  document.getElementById('study-all-btn').style.display = currentTopicId?'':'none';
  if(studyQueue.length===0){ showStudyDone(); return; }
  showCard();
}

function showCard(){
  if(studyIdx >= studyQueue.length){ showStudyDone(); return; }
  const w = studyQueue[studyIdx];
  currentWord = w.word;
  const p = getWProg(w.topicId, w.word);
  cardFlipped = false;
  document.getElementById('flashcard').classList.remove('flipped');
  document.getElementById('rating-area').classList.remove('show');
  document.getElementById('cf-word').textContent = w.word;
  document.getElementById('cf-ph').textContent = w.phonetic||'';
  document.getElementById('cf-type').textContent = w.type||'';
  const partEl = document.getElementById('cf-part');
  if(w.toeicPart){ partEl.textContent=w.toeicPart; partEl.style.display='inline-block'; } else { partEl.style.display='none'; }
  document.getElementById('cb-def').textContent = w.definition||'';
  document.getElementById('cb-vn').textContent = w.vietnamese||'';
  document.getElementById('cb-ex').textContent = w.example ? `"${w.example}"` : '';
  document.getElementById('ai-explain-box').style.display='none';
  updateStudyBar();

  // Spelling step for new words
  if(p.status==='new'){
    isSpelling = true;
    document.getElementById('spelling-screen').style.display='block';
    document.getElementById('card-wrap-main').style.display='none';
    document.getElementById('spell-ph').textContent = w.phonetic||'';
    document.getElementById('spell-type').textContent = w.type||'';
    buildSpellingOpts(w);
    speakCurrent();
  } else {
    isSpelling = false;
    document.getElementById('spelling-screen').style.display='none';
    document.getElementById('card-wrap-main').style.display='block';
    speakCurrent();
  }
}

function buildSpellingOpts(w){
  // Generate 3 misspelled variants of the correct word
  function makeVariants(word) {
    const variants = new Set();
    const letters = 'abcdefghijklmnopqrstuvwxyz';
    let attempts = 0;
    while(variants.size < 3 && attempts < 60) {
      attempts++;
      const arr = word.split('');
      const type = Math.floor(Math.random() * 4);
      if(type === 0 && arr.length > 1) {
        // Swap two adjacent letters
        const i = Math.floor(Math.random() * (arr.length - 1));
        [arr[i], arr[i+1]] = [arr[i+1], arr[i]];
      } else if(type === 1 && arr.length > 2) {
        // Change one letter
        const i = Math.floor(Math.random() * arr.length);
        const newChar = letters[Math.floor(Math.random()*letters.length)];
        if(newChar !== arr[i]) arr[i] = newChar;
      } else if(type === 2 && arr.length > 3) {
        // Remove one letter
        const i = 1 + Math.floor(Math.random() * (arr.length - 2));
        arr.splice(i, 1);
      } else {
        // Double a letter
        const i = Math.floor(Math.random() * arr.length);
        arr.splice(i, 0, arr[i]);
      }
      const v = arr.join('');
      if(v !== word && v.length > 1) variants.add(v);
    }
    // Pad if not enough
    while(variants.size < 3) variants.add(word.slice(0,-1) + letters[Math.floor(Math.random()*26)]);
    return [...variants].slice(0,3);
  }

  const wrongOpts = makeVariants(w.word);
  const allOpts = [w.word, ...wrongOpts].sort(() => Math.random() - 0.5);
  const el = document.getElementById('spell-opts');
  el.innerHTML = allOpts.map(opt =>
    `<button class="spell-opt" onclick="checkSpelling(this,'${opt}','${w.word}')">${opt}</button>`
  ).join('');
  document.getElementById('spell-feedback').style.display='none';
}

function checkSpelling(btn, chosen, correct){
  const opts = document.querySelectorAll('.spell-opt');
  opts.forEach(o=>o.classList.add('disabled'));
  if(chosen===correct){
    btn.classList.add('correct');
    document.getElementById('spell-feedback').style.display='block';
    document.getElementById('spell-feedback').textContent='âœ… ÄÃºng rá»“i! HÃ£y há»c tháº» tá»« â†’';
    setTimeout(()=>{ isSpelling=false; document.getElementById('spelling-screen').style.display='none'; document.getElementById('card-wrap-main').style.display='block'; }, 900);
  } else {
    btn.classList.add('wrong');
    opts.forEach(o=>{ if(o.textContent===correct) o.classList.add('reveal'); });
    document.getElementById('spell-feedback').style.display='block';
    document.getElementById('spell-feedback').textContent='âŒ Sai rá»“i! HÃ£y ghi nhá»› tá»« nÃ y.';
    document.getElementById('spell-feedback').style.color='var(--red)';
    setTimeout(()=>{ isSpelling=false; document.getElementById('spelling-screen').style.display='none'; document.getElementById('card-wrap-main').style.display='block'; }, 1200);
  }
}

function flipCard(){
  if(isSpelling) return;
  cardFlipped = !cardFlipped;
  document.getElementById('flashcard').classList.toggle('flipped', cardFlipped);
  if(cardFlipped){ document.getElementById('rating-area').classList.add('show'); updateNextTimes(); }
}

function updateNextTimes(){
  const w = studyQueue[studyIdx];
  const p = getWProg(w.topicId, w.word);
  [0,1,2,3].forEach(q=>{
    const r = sm2(p,q);
    const day = Math.round(r.interval);
    document.getElementById(`nx${q}`).textContent = day>1?`${day}d`:'1d';
  });
}

function rate(q){
  const w = studyQueue[studyIdx];
  const p = getWProg(w.topicId, w.word);
  const newP = sm2(p, q);
  setWProg(w.topicId, w.word, newP);
  studyIdx++;
  updateHeader();
  showCard();
}

function showStudyDone(){ document.getElementById('study-done').style.display='block'; document.getElementById('study-main').style.display='none'; }
function clearFilter(){ currentTopicId=null; initStudy(); }
function updateStudyBar(){
  const pct = studyQueue.length ? Math.round(studyIdx/studyQueue.length*100) : 100;
  document.getElementById('study-bar').style.width=pct+'%';
  document.getElementById('study-cnt').textContent=`${studyIdx}/${studyQueue.length}`;
}
function quickStudy(topicId, idx){
  currentTopicId = topicId;
  switchTab('study');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ â€“ TOEIC STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initQuiz(){
  const words = currentTopicId ? (CLOUD.topics||[]).find(t=>t.id===currentTopicId)?.words?.map(w=>({...w,topicId:currentTopicId}))||[] : getAllWords();
  if(words.length < 4){ document.getElementById('quiz-main').style.display='none'; document.getElementById('quiz-empty').style.display='block'; return; }
  document.getElementById('quiz-main').style.display='block'; document.getElementById('quiz-empty').style.display='none';
  nextQ();
}

function setQType(type){
  currentQType = type;
  document.querySelectorAll('.qtype-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('qt-'+type)?.classList.add('active');
  nextQ();
}

async function nextQ(){
  const allWords = currentTopicId ? (CLOUD.topics||[]).find(t=>t.id===currentTopicId)?.words?.map(w=>({...w,topicId:currentTopicId}))||[] : getAllWords();
  if(allWords.length < 4) return;
  let type = currentQType;
  if(type==='random') type = ['part5','part6','meaning'][Math.floor(Math.random()*3)];
  if(type==='part5') makeP5Question(allWords);
  else if(type==='part6') await makeP6Question(allWords);
  else makeMeaningQ(allWords);
}

// PART 5 â€“ Incomplete Sentence (choose word to fill blank)
function makeP5Question(words){
  const w = words[Math.floor(Math.random()*words.length)];
  currentQWord = w.word;
  const others = words.filter(x=>x.word!==w.word).sort(()=>Math.random()-.5).slice(0,3);
  const opts = [w, ...others].sort(()=>Math.random()-.5);

  document.getElementById('q-part-badge').className='toeic-part-lbl part5-lbl';
  document.getElementById('q-part-badge').textContent='Part 5 â€“ Incomplete Sentences';
  document.getElementById('q-lbl').textContent='Chá»n tá»« Ä‘Ãºng Ä‘á»ƒ hoÃ n thÃ nh cÃ¢u';
  document.getElementById('q-word').style.display='none';
  document.getElementById('q-ph').style.display='none';
  document.getElementById('q-speak-btn').style.display='none';
  document.getElementById('q-passage').style.display='none';
  document.getElementById('fillblank-ex').style.display='none';

  // Generate sentence with blank
  const sentence = w.example ? w.example.replace(new RegExp('\\b'+escapeRegex(w.word)+'\\b','i'), '___________') : `The manager asked everyone to ___________.`;
  const sentEl = document.getElementById('q-sent');
  sentEl.style.display='block';
  sentEl.innerHTML = sentence.replace('___________','<span class="blank">___________</span>');

  const optsEl = document.getElementById('quiz-opts');
  optsEl.innerHTML = opts.map((o,i)=>`
    <button class="q-opt" data-val="${o.word}" onclick="checkMCQ(this,'${o.word}','${w.word}','${w.word}')">
      <div class="q-opt-inner"><span class="opt-letter">${'ABCD'[i]}</span>${o.word}</div>
    </button>`).join('');
  document.getElementById('quiz-q-card').style.display='block';
  optsEl.style.display='grid';
}

// PART 6 â€“ AI-generated passage using actual vocabulary words from the list
let p6Blanks = [];
let p6BlankIdx = 0;
let p6PassageTemplate = '';
let p6PassageWords = [];

// TOEIC genre pool â€” covers Parts 1-7
const P6_GENRES = [
  { label:'Email',         badge:'part6-lbl', toeicPart:'Part 6 â€“ Text Completion',      hint:'Read the email and choose the correct word for each blank.' },
  { label:'Memo',          badge:'part6-lbl', toeicPart:'Part 6 â€“ Text Completion',      hint:'Read the memo and choose the correct word for each blank.' },
  { label:'Announcement',  badge:'part6-lbl', toeicPart:'Part 6 â€“ Text Completion',      hint:'Read the announcement and choose the correct word for each blank.' },
  { label:'Notice',        badge:'part6-lbl', toeicPart:'Part 6 â€“ Text Completion',      hint:'Read the notice and choose the correct word for each blank.' },
  { label:'Article',       badge:'part7-lbl', toeicPart:'Part 7 â€“ Reading Comprehension',hint:'Read the article and choose the correct word for each blank.' },
  { label:'Leaflet',       badge:'part7-lbl', toeicPart:'Part 7 â€“ Reading Comprehension',hint:'Read the leaflet and choose the correct word for each blank.' },
  { label:'Advertisement', badge:'part7-lbl', toeicPart:'Part 7 â€“ Reading Comprehension',hint:'Read the advertisement and choose the correct word for each blank.' },
  { label:'Report',        badge:'part7-lbl', toeicPart:'Part 7 â€“ Reading Comprehension',hint:'Read the report excerpt and choose the correct word for each blank.' },
  { label:'Conversation',  badge:'part5-lbl', toeicPart:'Part 3 â€“ Conversations',        hint:'Read the conversation and choose the correct word for each blank.' },
  { label:'Talk',          badge:'part5-lbl', toeicPart:'Part 4 â€“ Talks',                hint:'Read the talk and choose the correct word for each blank.' },
  { label:'Description',   badge:'part5-lbl', toeicPart:'Part 1 â€“ Scene Description',    hint:'Read the scene description and choose the correct word for each blank.' },
];

async function makeP6Question(words){
  // UI: loading state
  document.getElementById('q-part-badge').className='toeic-part-lbl part6-lbl';
  document.getElementById('q-part-badge').textContent='Part 6 â€“ Text Completion';
  document.getElementById('q-lbl').textContent='Äang táº¡o Ä‘oáº¡n vÄƒn tá»« tá»« vá»±ng cá»§a báº¡n...';
  ['q-word','q-ph','q-speak-btn','q-sent','fillblank-ex'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  document.getElementById('quiz-opts').innerHTML='';
  document.getElementById('quiz-opts').style.display='none';
  const passEl = document.getElementById('q-passage');
  passEl.style.display='block';
  document.getElementById('q-passage-title').textContent='â³ Generating...';
  document.getElementById('q-passage-text').innerHTML=
    '<span style="color:var(--text2);font-size:13px;"><span class="spinner"></span> Claude Ä‘ang táº¡o Ä‘oáº¡n vÄƒn tá»« cÃ¡c tá»« vá»±ng...</span>';

  // Pick blank words & genre
  const numBlanks = Math.min(4, Math.max(3, words.length >= 4 ? 4 : 3));
  const blankWords = words.slice().sort(()=>Math.random()-.5).slice(0, numBlanks);
  const genre = P6_GENRES[Math.floor(Math.random()*P6_GENRES.length)];

  // Generate passage (AI or fallback)
  let passageText = null;
  if(CFG.claudeKey){
    try { passageText = await generateP6Passage(blankWords, genre); }
    catch(e){ console.warn('P6 AI failed, using fallback:', e.message); }
  }
  if(!passageText){
    passageText = buildFallbackPassage(blankWords, genre);
  }

  // Build blanks data
  p6PassageTemplate = passageText;
  p6PassageWords = blankWords;
  p6BlankIdx = 0;
  p6Blanks = blankWords.map(w => {
    const distractors = words.filter(x=>x.word!==w.word).sort(()=>Math.random()-.5).slice(0,3);
    const opts = [w,...distractors].sort(()=>Math.random()-.5);
    return { word: w, opts, answered: false, chosen: null };
  });

  // Update UI with actual genre
  document.getElementById('q-part-badge').className='toeic-part-lbl '+genre.badge;
  document.getElementById('q-part-badge').textContent = genre.toeicPart;
  document.getElementById('q-lbl').textContent = genre.hint;
  document.getElementById('q-passage-title').textContent = genre.label;

  renderP6Passage();
  passEl.style.display='block';
  renderP6Options();
}

async function generateP6Passage(blankWords, genre){
  const wordList = blankWords.map((w,i)=>
    `[BLANK_${i}] = "${w.word}" (${w.type||'n/v'}): ${w.definition}`
  ).join('\n');

  const systemPrompt = `You are a professional TOEIC exam writer. Write authentic TOEIC-style passages.
STRICT RULES:
1. Write a ${genre.label} in natural, professional English, 80-140 words total.
2. Use EXACTLY these placeholder tokens in the passage where each word belongs: [BLANK_0], [BLANK_1], [BLANK_2]${blankWords.length>3?', [BLANK_3]':''}
3. Each [BLANK_X] must fit perfectly â€” grammatically and contextually â€” so the correct answer is the mapped word.
4. For "Conversation": write as an A:/B: dialogue (4-6 turns).
5. For "Description": describe a workplace photo scene.
6. For "Talk": write as a spoken announcement or briefing transcript.
7. For "Email": include To:/From:/Subject: header.
8. For "Memo": include MEMO header with To:/From:/Re:.
9. For "Article": write as a business news article with a headline.
10. For "Leaflet"/"Advertisement": use headline + bullet points or short paragraphs.
11. Output ONLY the passage text â€” no explanation, no JSON, no markdown, no extra commentary.`;

  const userPrompt = `Genre: ${genre.label}

Words to embed as blanks:
${wordList}

Write the ${genre.label} now. Use [BLANK_0], [BLANK_1], [BLANK_2]${blankWords.length>3?', [BLANK_3]':''} exactly where those words fit.`;

  const raw = await claudeCall(systemPrompt, userPrompt, 700);
  const clean = raw.trim();

  // Validate all blank tokens present
  for(let i=0; i<blankWords.length; i++){
    if(!clean.includes(`[BLANK_${i}]`))
      throw new Error(`Missing [BLANK_${i}] in generated passage`);
  }
  return clean;
}

function buildFallbackPassage(blankWords, genre){
  // Deterministic fallback when no API key â€” uses actual words from blankWords
  const fill = (i) => `[BLANK_${i}]`;
  const n = blankWords.length;

  const templates = {
    Email: `To: All Staff\nFrom: Human Resources\nSubject: Office Update\n\nDear Team,\n\nThis is to inform you that we will ${fill(0)} the updated workplace policy starting next Monday. All staff are expected to ${fill(1)} these new guidelines carefully.\n\nYour ${fill(2)} is required before the end of this week.${n>3?' Please '+fill(3)+' your manager if you have any questions.':''}\n\nBest regards,\nHR Department`,
    Memo: `MEMO\nTo: Department Heads\nFrom: Operations\nDate: This Week\n\nThis memo confirms that the ${fill(0)} has been approved for Q4. All managers should ${fill(1)} their teams on the new procedures.\n\nThe ${fill(2)} deadline is Friday.${n>3?' Please submit the completed '+fill(3)+' to your department head.':''}`,
    Announcement: `ANNOUNCEMENT\n\nWe are pleased to announce the upcoming ${fill(0)}. This initiative aims to ${fill(1)} communication across all departments.\n\nYour ${fill(2)} is warmly welcomed.${n>3?' For more details, please review the official '+fill(3)+'.':''}`,
    Notice: `NOTICE TO ALL EMPLOYEES\n\nPlease be advised that the ${fill(0)} process will begin next week. All employees must ${fill(1)} the revised safety guidelines.\n\nA ${fill(2)} will be circulated before Friday.${n>3?' Managers should also attend the '+fill(3)+' on Thursday.':''}`,
    Article: `WORKPLACE NEWS\n\nLocal companies are increasingly focusing on ${fill(0)} to boost staff morale. Experts suggest that firms should ${fill(1)} flexible policies to attract top talent.\n\nOne HR director noted that a strong ${fill(2)} culture is key to long-term success.${n>3?' Recent surveys show that ${fill(3)} directly impacts overall company performance.':''}`,
    Leaflet: `IMPROVE YOUR WORKPLACE TODAY\n\nDiscover how to ${fill(0)} effectively in any professional environment.\n\nâ€¢ Learn to ${fill(1)} your daily tasks with confidence\nâ€¢ Build a stronger ${fill(2)} culture within your team${n>3?'\nâ€¢ Achieve greater '+fill(3)+' with proven strategies':''}\n\nContact us to learn more.`,
    Advertisement: `LOOKING FOR A SMARTER WAY TO ${fill(0).toUpperCase()}?\n\nOur platform helps your team ${fill(1)} faster and more efficiently than ever before.\n\nWith built-in tools for ${fill(2)}, you\'ll see results from day one.${n>3?' Start your free trial and experience the power of '+fill(3)+' today.':''}`,
    Report: `QUARTERLY PERFORMANCE REPORT\n\nThis report outlines the key areas where the organization must ${fill(0)} over the coming months. The ${fill(1)} data shows consistent improvement across departments.\n\nManagement recommends that all teams ${fill(2)} their current workflows.${n>3?' The ${fill(3)} figures will be reviewed at the next board meeting.':''}`,
    Conversation: `A: Have you had time to review the ${fill(0)} for tomorrow?\nB: Yes, I just finished it. I noticed the ${fill(1)} has been rescheduled.\nA: That\'s right. Could you send a ${fill(2)} to everyone on your team?\nB: Of course. I\'ll do that right away.${n>3?'\nA: Great. Also, please make sure to '+fill(3)+' the updated report before the meeting.':''}`,
    Talk: `Good morning, everyone. Thank you for joining today\'s ${fill(0)}. I\'d like to take a moment to ${fill(1)} some important updates with the team.\n\nFirst, we will be implementing a new ${fill(2)} system starting next quarter.${n>3?' I also want to remind everyone to complete the '+fill(3)+' form before Friday.':''}\n\nThank you for your attention.`,
    Description: `The image shows a busy office environment. In the foreground, a professional is reviewing a ${fill(0)} at their workstation. Several colleagues are gathered around a table, engaged in a ${fill(1)}.\n\nOn the wall, there is a large ${fill(2)} chart displaying key figures.${n>3?' One employee appears to be updating a '+fill(3)+' on the shared screen.':''}`,
  };

  return templates[genre.label] || templates['Email'];
}
function renderP6Passage(){
  // Replace blank tokens: answered ones show the word, current blank shows underline, future show grey underline
  let html = p6PassageTemplate;
  p6Blanks.forEach((b, i) => {
    let replacement;
    if(b.answered){
      const isCorrect = b.chosen === b.word.word;
      replacement = `<span style="font-weight:700;color:${isCorrect?'var(--green)':'var(--red)'};">${b.chosen}</span>`;
    } else if(i === p6BlankIdx){
      replacement = `<span class="blank" id="p6-active-blank">___________</span>`;
    } else {
      replacement = `<span style="display:inline-block;min-width:80px;border-bottom:2px solid var(--border2);color:var(--text3);padding:0 4px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>`;
    }
    html = html.replace(`[BLANK_${i}]`, replacement);
  });
  html = html.replace(/\n/g, '<br>');
  document.getElementById('q-passage-text').innerHTML = html;
}

function renderP6Options(){
  if(p6BlankIdx >= p6Blanks.length){ 
    // All blanks answered â€” show next question button after brief pause
    document.getElementById('quiz-opts').innerHTML='';
    setTimeout(nextQ, 1200);
    return;
  }
  document.getElementById('q-lbl').textContent=`Chá»n tá»« Ä‘Ãºng cho chá»— trá»‘ng ${p6BlankIdx+1}/${p6Blanks.length}`;
  const blank = p6Blanks[p6BlankIdx];
  const optsEl = document.getElementById('quiz-opts');
  optsEl.style.display='grid';
  optsEl.innerHTML = blank.opts.map((o,i)=>`
    <button class="q-opt" data-val="${o.word}" onclick="checkP6MCQ(this,'${o.word}','${blank.word.word}')">
      <div class="q-opt-inner"><span class="opt-letter">${'ABCD'[i]}</span>${o.word}</div>
    </button>`).join('');
}

function checkP6MCQ(btn, chosen, correct){
  const opts = document.querySelectorAll('.q-opt');
  opts.forEach(o=>o.classList.add('disabled'));
  quizTotal++;
  p6Blanks[p6BlankIdx].answered = true;
  p6Blanks[p6BlankIdx].chosen = chosen;
  if(chosen===correct){
    btn.classList.add('correct'); quizCorrect++;
    speakWord(correct); // Bug 4: auto-read correct answer
  } else {
    btn.classList.add('wrong'); quizWrong++;
    opts.forEach(o=>{ if(o.getAttribute('data-val')===correct) o.classList.add('reveal'); });
  }
  updateQuizStats();
  renderP6Passage(); // update passage to show answered blank
  p6BlankIdx++;
  setTimeout(renderP6Options, 1000);
}

// Meaning question (traditional)
function makeMeaningQ(words){
  const w = words[Math.floor(Math.random()*words.length)];
  currentQWord = w.word;
  const others = words.filter(x=>x.word!==w.word).sort(()=>Math.random()-.5).slice(0,3);
  const opts = [w,...others].sort(()=>Math.random()-.5);

  document.getElementById('q-part-badge').className='toeic-part-lbl part5-lbl';
  document.getElementById('q-part-badge').textContent='Vocabulary';
  document.getElementById('q-lbl').textContent='Chá»n nghÄ©a Ä‘Ãºng cá»§a tá»«';
  document.getElementById('q-word').textContent=w.word; document.getElementById('q-word').style.display='block';
  document.getElementById('q-ph').textContent=w.phonetic||''; document.getElementById('q-ph').style.display='block';
  document.getElementById('q-speak-btn').style.display='flex';
  document.getElementById('q-sent').style.display='none';
  document.getElementById('q-passage').style.display='none';
  document.getElementById('fillblank-ex').style.display='none';

  const optsEl = document.getElementById('quiz-opts');
  optsEl.innerHTML = opts.map((o,i)=>`
    <button class="q-opt" data-val="${o.vietnamese}" onclick="checkMCQ(this,'${o.vietnamese}','${w.vietnamese}','${w.word}')">
      <div class="q-opt-inner"><span class="opt-letter">${'ABCD'[i]}</span>${o.vietnamese}</div>
    </button>`).join('');
  optsEl.style.display='grid';
}

function updateQuizStats(){
  document.getElementById('qc').textContent=quizCorrect;
  document.getElementById('qw').textContent=quizWrong;
  document.getElementById('qt').textContent=quizTotal;
  document.getElementById('qa').textContent=quizTotal?Math.round(quizCorrect/quizTotal*100)+'%':'â€”';
}

function checkMCQ(btn, chosen, correct, wordToSpeak){
  const opts = document.querySelectorAll('.q-opt');
  opts.forEach(o=>o.classList.add('disabled'));
  quizTotal++;
  if(chosen===correct){
    btn.classList.add('correct'); quizCorrect++;
    // Bug 4: auto-read the word when correct
    if(wordToSpeak) speakWord(wordToSpeak);
  } else {
    btn.classList.add('wrong'); quizWrong++;
    opts.forEach(o=>{
      // find the correct option by data attribute
      if(o.getAttribute('data-val')===correct) o.classList.add('reveal');
    });
  }
  updateQuizStats();
  setTimeout(nextQ, 1400);
}

function checkFillBlank(){/* fillblank placeholder */}
function resetFillBlank(){/* placeholder */}
function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEADER & PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHeader(){
  const all = getAllWords();
  const now = Date.now();
  const due = all.filter(w=>{ const p=getWProg(w.topicId,w.word); return p.status==='new'||p.due<=now; }).length;
  const mastered = all.filter(w=>getWProg(w.topicId,w.word).status==='mastered').length;
  document.getElementById('h-total').textContent = all.length;
  document.getElementById('h-due').textContent = due;
  document.getElementById('h-mastered').textContent = mastered;
}

function updateProgress(){
  const all = getAllWords();
  const counts = {new:0,learning:0,review:0,mastered:0};
  all.forEach(w=>{ const s=getWProg(w.topicId,w.word).status||'new'; counts[s]=(counts[s]||0)+1; });
  document.getElementById('p-new').textContent=counts.new||0;
  document.getElementById('p-learn').textContent=counts.learning||0;
  document.getElementById('p-rev').textContent=counts.review||0;
  document.getElementById('p-master').textContent=counts.mastered||0;
  const total = all.length || 1;
  const pct = Math.round((counts.mastered||0)/total*100);
  document.getElementById('pct').textContent=pct+'%';
  const circ = 2*Math.PI*62;
  document.getElementById('donut').setAttribute('stroke-dasharray',`${circ*pct/100} ${circ}`);
}

function buildStreak(){
  const el = document.getElementById('streak');
  const days = [];
  for(let i=29;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const key='streak_'+d.toISOString().slice(0,10);
    const active = localStorage.getItem(key)==='1';
    const label = d.getDate();
    days.push(`<div class="day ${active?'ok':''}">${label}</div>`);
  }
  el.innerHTML=days.join('');
  localStorage.setItem('streak_'+new Date().toISOString().slice(0,10),'1');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEECH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function speakCurrent(){
  const w = studyQueue[studyIdx];
  if(w) speakWord(w.word);
}
function speakWord(word){
  if(!word||word==='â€”') return;
  // Cancel any ongoing speech first to prevent partial/stuttered playback
  speechSynthesis.cancel();
  // Small delay needed for some browsers after cancel()
  setTimeout(()=>{
    const utt = new SpeechSynthesisUtterance(word);
    utt.lang = 'en-US';
    utt.rate = 0.85;
    utt.pitch = 1;
    // Prefer a good English voice if available
    const voices = speechSynthesis.getVoices();
    const enVoice = voices.find(v=>v.lang==='en-US' && v.name.toLowerCase().includes('google'))
                 || voices.find(v=>v.lang==='en-US')
                 || voices.find(v=>v.lang.startsWith('en'));
    if(enVoice) utt.voice = enVoice;
    speechSynthesis.speak(utt);
  }, 120);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN â€“ TOPICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdminTopics(){
  const list = document.getElementById('a-topic-list');
  list.innerHTML = (CLOUD.topics||[]).map(t=>`
    <div class="t-row">
      <div style="font-size:22px">${t.emoji||'ğŸ“š'}</div>
      <div class="t-row-info">
        <div class="t-row-name">${t.name}</div>
        <div class="t-row-count">${(t.words||[]).length} tá»«</div>
      </div>
      <button class="btn btn-s btn-sm" onclick="editTopic('${t.id}')">âœï¸ Sá»­a</button>
      <button class="btn btn-d btn-sm" onclick="deleteTopic('${t.id}')">ğŸ—‘</button>
    </div>`).join('');
}
function openTopicForm(){ document.getElementById('topic-form').style.display='block'; document.getElementById('tf-title').textContent='ThÃªm chá»§ Ä‘á» má»›i'; editTopicId=null; document.getElementById('tf-name').value=''; document.getElementById('tf-emoji').value='ğŸ’¼'; }
function closeTopicForm(){ document.getElementById('topic-form').style.display='none'; editTopicId=null; }
function editTopic(id){
  const t=(CLOUD.topics||[]).find(x=>x.id===id); if(!t) return;
  editTopicId=id;
  document.getElementById('tf-title').textContent='Sá»­a chá»§ Ä‘á»';
  document.getElementById('tf-name').value=t.name;
  document.getElementById('tf-emoji').value=t.emoji||'ğŸ“š';
  document.getElementById('tf-color').value=t.color||'#3b82f6';
  document.getElementById('topic-form').style.display='block';
}
async function saveTopic(){
  const name=document.getElementById('tf-name').value.trim();
  const emoji=document.getElementById('tf-emoji').value.trim()||'ğŸ“š';
  const color=document.getElementById('tf-color').value;
  if(!name){ showToast('âš ï¸ Nháº­p tÃªn chá»§ Ä‘á»!'); return; }
  if(!CLOUD.topics) CLOUD.topics=[];
  if(editTopicId){
    const t=CLOUD.topics.find(x=>x.id===editTopicId);
    if(t){t.name=name;t.emoji=emoji;t.color=color;}
  } else {
    CLOUD.topics.push({id:'t'+Date.now(),name,emoji,color,words:[]});
  }
  await syncCloud(false);
  renderAdminTopics(); populateTopicSelects();
  closeTopicForm(); showToast('âœ… ÄÃ£ lÆ°u chá»§ Ä‘á»!');
}
async function deleteTopic(id){
  if(!confirm('XoÃ¡ chá»§ Ä‘á» nÃ y?')) return;
  CLOUD.topics=(CLOUD.topics||[]).filter(t=>t.id!==id);
  await syncCloud(false);
  renderAdminTopics(); populateTopicSelects(); showToast('âœ… ÄÃ£ xoÃ¡!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN â€“ WORDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateTopicSelects(){
  const topics = CLOUD.topics||[];
  const html = topics.map(t=>`<option value="${t.id}">${t.emoji} ${t.name}</option>`).join('');
  ['a-topic-sel','aigen-topic-sel','import-topic-sel'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=html; });
  loadWords();
}
function loadWords(){
  const sel = document.getElementById('a-topic-sel');
  if(!sel) return;
  const tid = sel.value;
  const t = (CLOUD.topics||[]).find(x=>x.id===tid);
  document.getElementById('word-count-lbl').textContent = t ? `${(t.words||[]).length} tá»« trong chá»§ Ä‘á» nÃ y` : '';
  const tbody = document.getElementById('word-tbody');
  if(!t){ tbody.innerHTML=''; return; }
  tbody.innerHTML = (t.words||[]).map((w,i)=>`
    <tr>
      <td><strong>${w.word}</strong></td>
      <td style="color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:12px">${w.phonetic||''}</td>
      <td>${w.vietnamese||''}</td>
      <td style="color:var(--text2);font-size:12px">${w.definition||''}</td>
      <td><button class="btn btn-d btn-sm" onclick="deleteWord('${tid}',${i})">ğŸ—‘</button></td>
    </tr>`).join('');
}
function openWordForm(){ document.getElementById('word-form').style.display='block'; editWordIdx=null; ['wf-word','wf-ph','wf-type','wf-vn','wf-def','wf-ex'].forEach(id=>document.getElementById(id).value=''); }
function closeWordForm(){ document.getElementById('word-form').style.display='none'; }
async function saveWord(){
  const tid = document.getElementById('a-topic-sel').value;
  const t = (CLOUD.topics||[]).find(x=>x.id===tid); if(!t){ showToast('âš ï¸ Chá»n chá»§ Ä‘á»!'); return; }
  const word = document.getElementById('wf-word').value.trim(); if(!word){ showToast('âš ï¸ Nháº­p tá»«!'); return; }
  if(!t.words) t.words=[];
  const w = {word, phonetic:document.getElementById('wf-ph').value.trim(), type:document.getElementById('wf-type').value.trim(), definition:document.getElementById('wf-def').value.trim(), example:document.getElementById('wf-ex').value.trim(), vietnamese:document.getElementById('wf-vn').value.trim()};
  t.words.push(w);
  await syncCloud(false);
  loadWords(); closeWordForm(); showToast('âœ… ÄÃ£ thÃªm tá»«!');
}
async function deleteWord(tid, idx){
  const t=(CLOUD.topics||[]).find(x=>x.id===tid); if(!t) return;
  t.words.splice(idx,1);
  await syncCloud(false);
  loadWords(); showToast('âœ… ÄÃ£ xoÃ¡ tá»«!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleCSV(input){
  const file = input.files[0]; if(!file) return;
  const text = await file.text();
  const lines = text.trim().split('\n').slice(1); // skip header
  const tid = document.getElementById('import-topic-sel').value;
  const t = (CLOUD.topics||[]).find(x=>x.id===tid); if(!t){ showToast('âš ï¸ Chá»n chá»§ Ä‘á»!'); return; }
  if(!t.words) t.words=[];
  let added=0;
  lines.forEach(line=>{
    const [word,phonetic,type,definition,example,vietnamese] = line.split(',').map(s=>s.trim().replace(/^"|"$/g,''));
    if(word && !t.words.find(w=>w.word===word)){ t.words.push({word,phonetic,type,definition,example,vietnamese}); added++; }
  });
  await syncCloud(false);
  document.getElementById('import-result').style.display='block';
  document.getElementById('import-result').textContent=`âœ… ÄÃ£ import ${added} tá»«!`;
  showToast(`âœ… Import ${added} tá»« thÃ nh cÃ´ng!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function claudeCall(sys,user,maxT=1500){
  if(!CFG.claudeKey) throw new Error('no_key');
  const res = await fetch(CLAUDE_URL,{method:'POST',headers:{'Content-Type':'application/json','x-api-key':CFG.claudeKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-5-20250929',max_tokens:maxT,system:sys,messages:[{role:'user',content:user}]})});
  if(!res.ok){ const e=await res.json(); throw new Error(e.error?.message||'API error'); }
  return (await res.json()).content[0].text;
}

async function aiGenerate(){
  if(!CFG.claudeKey){ document.getElementById('aigen-no-key').style.display='block'; return; }
  document.getElementById('aigen-no-key').style.display='none';
  const topic = document.getElementById('aigen-topic-input').value.trim();
  if(!topic){ showToast('âš ï¸ Nháº­p chá»§ Ä‘á»!'); return; }
  const count = document.getElementById('aigen-count').value;
  const btn = document.getElementById('aigen-btn');
  btn.innerHTML='<span class="spinner"></span> Äang táº¡o...'; btn.disabled=true;
  document.getElementById('aigen-result').style.display='none';

  const sys = `You are a TOEIC vocabulary expert. Return ONLY valid JSON array, no markdown.
Each item: {"word":"...","phonetic":"...","type":"...","definition":"...","example":"...","vietnamese":"..."}
Rules:
- phonetic: IPA notation
- type: n/v/adj/adv/phrase
- definition: clear English definition
- example: a realistic TOEIC business sentence (like those in TOEIC Part 5/6) using the word naturally
- vietnamese: accurate Vietnamese translation
Focus on business English vocabulary that appears in TOEIC exams.`;
  const prompt = `Generate ${count} TOEIC business vocabulary items for topic: "${topic}". Return ONLY JSON array.`;
  try {
    const raw = await claudeCall(sys, prompt, 2000);
    aiGenBuffer = JSON.parse(raw.replace(/```json|```/g,'').trim());
    document.getElementById('aigen-result-count').textContent=`${aiGenBuffer.length} tá»« Ä‘Æ°á»£c táº¡o`;
    document.getElementById('aigen-tbody').innerHTML=aiGenBuffer.map(w=>`
      <tr>
        <td><strong>${w.word||''}</strong></td>
        <td style="color:var(--purple);font-family:'JetBrains Mono',monospace;font-size:12px">${w.phonetic||''}</td>
        <td>${w.vietnamese||''}</td>
        <td style="color:var(--text2);font-size:12px">${w.definition||''}</td>
      </tr>`).join('');
    document.getElementById('aigen-result').style.display='block';
    showToast(`âœ… Táº¡o xong ${aiGenBuffer.length} tá»«!`);
  } catch(e){ showToast('âŒ Lá»—i: '+(e.message||'KhÃ´ng táº¡o Ä‘Æ°á»£c')); }
  btn.innerHTML='âœ¨ Táº¡o tá»« vá»±ng TOEIC'; btn.disabled=false;
}

async function aiSaveWords(){
  if(!aiGenBuffer.length){ showToast('âš ï¸ ChÆ°a cÃ³ tá»« nÃ o!'); return; }
  const tid = document.getElementById('aigen-topic-sel').value;
  const t = (CLOUD.topics||[]).find(t=>t.id===tid); if(!t){ showToast('âš ï¸ Chá»n chá»§ Ä‘á»!'); return; }
  if(!t.words) t.words=[];
  let added=0;
  aiGenBuffer.forEach(w=>{ if(w.word && !t.words.find(x=>x.word===w.word)){ t.words.push(w); added++; } });
  await syncCloud(false);
  showToast(`âœ… ÄÃ£ lÆ°u ${added} tá»«!`);
  aiGenBuffer=[]; document.getElementById('aigen-result').style.display='none';
}

async function aiExplain(){
  if(!CFG.claudeKey){ showToast('ğŸ¤– ChÆ°a cÃ i Ä‘áº·t API key'); return; }
  const w = studyQueue[studyIdx]; if(!w) return;
  const btn=document.getElementById('ai-explain-btn');
  const box=document.getElementById('ai-explain-box');
  btn.innerHTML='<span class="spinner"></span>'; btn.disabled=true;
  box.style.display='block'; box.textContent='Äang há»i AI...';
  const sys=`You are a TOEIC tutor. Explain English vocabulary concisely in Vietnamese. Under 120 words.`;
  const prompt=`Giáº£i thÃ­ch tá»« "${w.word}" cho ngÆ°á»i há»c TOEIC:
- NghÄ©a chÃ­nh (tiáº¿ng Viá»‡t)
- CÃ¡ch dÃ¹ng trong kinh doanh (1-2 cÃ¢u)
- VÃ­ dá»¥ cÃ¢u theo phong cÃ¡ch TOEIC Part 5
- Tá»« loáº¡i vÃ  collocations phá»• biáº¿n
Ngáº¯n gá»n, thá»±c táº¿.`;
  try {
    const reply = await claudeCall(sys, prompt, 350);
    box.innerHTML=reply.replace(/\n/g,'<br>');
  } catch(e){ box.textContent='âŒ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c AI.'; }
  btn.innerHTML='ğŸ¤– AI giáº£i thÃ­ch'; btn.disabled=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadJson(key, def){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):def; } catch(e){ return def; } }
function saveJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
let toastTm;
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(toastTm); toastTm=setTimeout(()=>t.classList.remove('show'),2400); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
